<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apollo Sandbox — NUVELLA</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      background: #0a0a0f;
      overflow: hidden;
    }

    /* Sandbox Container - Full Screen */
    #embedded-sandbox {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* Optional: Custom loading overlay while Apollo loads */
    #initial-loader {
      position: fixed;
      inset: 0;
      background: #0a0a0f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    #initial-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(124, 58, 237, 0.2);
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Minimal initial loader -->
  <div id="initial-loader">
    <div class="loader-spinner"></div>
  </div>

  <!-- Apollo Sandbox Container -->
  <div id="embedded-sandbox"></div>

  <script>
    function createScript(src){
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.crossOrigin = "anonymous";
        s.onload = () => resolve(s);
        s.onerror = (e) => reject(new Error('Failed to load script: '+src));
        document.head.appendChild(s);
      });
    }

    (async function initSandbox(){
      const loader = document.getElementById('initial-loader');
      const holder = document.getElementById('embedded-sandbox');
      const endpoint = window.location.origin + '/graphql';

      console.log('NUVELLA: starting embedded sandbox init', { endpoint });

      try {
        // Load Apollo Sandbox script
        await createScript('https://embeddable-sandbox.cdn.apollographql.com/_latest/embeddable-sandbox.umd.production.min.js');

        // Wait for global to attach
        await new Promise(r => setTimeout(r, 50));

        // Get global export
        const Global = window.EmbeddedSandbox || 
                      window.embeddableSandbox || 
                      (window.EmbeddedSandbox && window.EmbeddedSandbox.default) || 
                      window.EmbeddedSandboxModule;

        if (!Global) throw new Error('EmbeddedSandbox global not found');

        // Create instance helper
        function tryCreateInstance(globalObj, options){
          if (typeof globalObj === 'function') {
            return new globalObj(options);
          }
          if (globalObj?.create) {
            return globalObj.create(options);
          }
          if (globalObj?.default && typeof globalObj.default === 'function') {
            return new globalObj.default(options);
          }
          if (globalObj?.EmbeddedSandbox) {
            return new globalObj.EmbeddedSandbox(options);
          }
          throw new Error('No suitable constructor found');
        }

        // Sandbox options with DARK theme
        const options = {
          target: '#embedded-sandbox',
          initialEndpoint: endpoint,
          includeCookies: false,
          initialState: { 
            theme: 'dark',
            // You can also configure document colors
            document: {
              variables: {}
            }
          },
          // Additional dark theme configuration
          persistExplorerState: false,
          handleRequest: undefined
        };

        // Create and render instance
        let instance;
        try {
          instance = tryCreateInstance(Global, options);
        } catch (e) {
          console.warn('Direct constructor failed, trying alternatives', e);
          if (typeof Global.render === 'function') {
            await Global.render(options);
            instance = Global;
          } else if (typeof Global.create === 'function') {
            instance = Global.create(options);
          } else {
            throw e;
          }
        }

        // Render
        if (instance?.render) {
          await instance.render();
        } else if (instance?.run) {
          await instance.run();
        }

        // Hide initial loader - Apollo will show its own loading
        setTimeout(() => {
          loader.classList.add('hidden');
          setTimeout(() => loader.style.display = 'none', 300);
        }, 300);

        console.log('✅ NUVELLA: Apollo Sandbox mounted with dark theme');

      } catch (err) {
        console.error('❌ NUVELLA: Failed to init Sandbox:', err);
        
        // Show error in initial loader
        loader.innerHTML = `
          <div style="text-align: center; color: #ef4444; padding: 20px;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">
              Failed to Load
            </div>
            <div style="font-size: 14px; color: #9ca3af; margin-bottom: 16px;">
              ${String(err.message || err)}
            </div>
            <button onclick="location.reload()" style="
              padding: 10px 20px;
              background: #7c3aed;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
            ">
              Reload
            </button>
          </div>
        `;
      }

    })();
  </script>

</body>
</html>